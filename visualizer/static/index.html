<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Codon Encoder Visualizer</title>
    <link rel="stylesheet" href="/static/css/style.css" />
  </head>
  <body>
    <div id="container"></div>

    <div id="controls">
      <h2>Hyperbolic Codon Space</h2>

      <!-- View Section - Always visible -->
      <div class="control-section" data-section="view">
        <div class="section-header" onclick="toggleSection('view')">
          <span class="section-toggle">&#9660;</span> View
        </div>
        <div class="section-content">
          <div class="control-group">
            <label>Projection</label>
            <select id="projectionMode">
              <option value="poincare">Poincare Disk (d -> radius)</option>
              <option value="pca">PCA 3D</option>
              <option value="hemisphere">Hemisphere</option>
            </select>
          </div>
          <div class="control-group">
            <label>Color By</label>
            <select id="colorBy">
              <optgroup label="Embedding Properties">
                <option value="depth">Depth (0-9)</option>
                <option value="confidence">Confidence</option>
                <option value="margin">Margin (basin boundary)</option>
                <option value="embedding_norm">Embedding Norm</option>
              </optgroup>
              <optgroup label="Genetic Code">
                <option value="amino_acid">Amino Acid</option>
                <option value="degeneracy">Degeneracy (1-6 fold)</option>
                <option value="gc_content">GC Content (%)</option>
                <option value="wobble">Wobble Base (3rd pos)</option>
              </optgroup>
              <optgroup label="Biochemical">
                <option value="hydrophobicity">Hydrophobicity</option>
                <option value="molecular_weight">Molecular Weight</option>
                <option value="chemical_class">Chemical Class</option>
              </optgroup>
              <optgroup label="Sequence">
                <option value="sequence">Sequence Position</option>
              </optgroup>
            </select>
          </div>
          <div class="control-group">
            <label>Trajectory Style</label>
            <select id="trajectoryStyle">
              <option value="geodesic">Geodesic Arcs</option>
              <option value="spiral">Spiral Path</option>
              <option value="linear">Linear</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Structures Section -->
      <div class="control-section" data-section="structures">
        <div class="section-header" onclick="toggleSection('structures')">
          <span class="section-toggle">&#9660;</span> Structures
        </div>
        <div class="section-content">
          <div class="control-group">
            <div class="control-row">
              <label><input type="checkbox" id="showDepthRings" checked />
                <span id="labelDepthRings">Depth Rings</span></label>
            </div>
            <div class="control-row">
              <label><input type="checkbox" id="showHierarchyTree" />
                <span id="labelHierarchyTree">Hierarchy Tree</span></label>
            </div>
            <div class="control-row">
              <label><input type="checkbox" id="showAllCodons" checked /> All Codons</label>
            </div>
            <div class="control-row" id="clusterCentersRow">
              <label><input type="checkbox" id="showClusterCenters" />
                <span id="labelClusterCenters">Cluster Centers</span></label>
            </div>
          </div>
          <div class="control-group">
            <label>Connections</label>
            <div class="control-row">
              <label><input type="checkbox" id="showFibers" /> Show</label>
              <select id="fiberMode" style="flex: 1; margin-left: 8px;">
                <option value="none">None</option>
                <option value="hierarchical" selected>Hierarchical</option>
                <option value="amino_acid">Amino Acid</option>
                <option value="depth">Adjacent Depth</option>
              </select>
            </div>
          </div>
        </div>
      </div>

      <!-- Filters Section -->
      <div class="control-section" data-section="filters">
        <div class="section-header" onclick="toggleSection('filters')">
          <span class="section-toggle">&#9660;</span> Filters <span id="filterInfo" class="section-info">64/64</span>
        </div>
        <div class="section-content">
          <div class="control-group">
            <div class="control-row">
              <span style="min-width: 45px; font-size: 10px;">Depth:</span>
              <input type="range" id="depthFilterMin" min="0" max="9" value="0" style="flex: 1;" />
              <input type="range" id="depthFilterMax" min="0" max="9" value="9" style="flex: 1;" />
              <span id="depthFilterLabel" style="min-width: 35px; font-size: 10px; text-align: right;">0-9</span>
            </div>
            <div class="control-row">
              <span style="min-width: 45px; font-size: 10px;">AA:</span>
              <select id="aminoAcidFilter" style="flex: 1;">
                <option value="all">All (21 types)</option>
                <optgroup label="Hydrophobic (8)">
                  <option value="A">A - Alanine</option>
                  <option value="V">V - Valine</option>
                  <option value="L">L - Leucine</option>
                  <option value="I">I - Isoleucine</option>
                  <option value="M">M - Methionine</option>
                  <option value="F">F - Phenylalanine</option>
                  <option value="W">W - Tryptophan</option>
                  <option value="P">P - Proline</option>
                </optgroup>
                <optgroup label="Polar (7)">
                  <option value="S">S - Serine</option>
                  <option value="T">T - Threonine</option>
                  <option value="N">N - Asparagine</option>
                  <option value="Q">Q - Glutamine</option>
                  <option value="Y">Y - Tyrosine</option>
                  <option value="C">C - Cysteine</option>
                  <option value="G">G - Glycine</option>
                </optgroup>
                <optgroup label="Basic + (3)">
                  <option value="K">K - Lysine</option>
                  <option value="R">R - Arginine</option>
                  <option value="H">H - Histidine</option>
                </optgroup>
                <optgroup label="Acidic - (2)">
                  <option value="D">D - Aspartate</option>
                  <option value="E">E - Glutamate</option>
                </optgroup>
                <optgroup label="Special">
                  <option value="*">* - Stop (3 codons)</option>
                </optgroup>
              </select>
            </div>
            <div class="control-row" style="margin-top: 4px;">
              <button id="resetFiltersBtn" style="font-size: 10px; padding: 3px 8px;">Reset Filters</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Encoding Section -->
      <div class="control-section" data-section="encoding">
        <div class="section-header" onclick="toggleSection('encoding')">
          <span class="section-toggle">&#9660;</span> DNA Encoding
        </div>
        <div class="section-content">
          <div class="control-group">
            <label>DNA Sequence</label>
            <form id="dnaForm" style="display: contents">
              <select id="sequenceList" style="margin-bottom: 6px; display: none; font-size: 11px">
                <option value="">-- Select Sequence --</option>
              </select>
              <input type="text" id="dnaInput" placeholder="ATGGCTCTGTGG..." />
            </form>
            <div id="dnaValidation" style="font-size: 10px; margin-top: 3px; min-height: 14px"></div>
          </div>
          <div class="control-group">
            <button id="encodeBtn">Encode</button>
            <button id="clearBtn">Clear</button>
            <button id="resetView">Reset View</button>
          </div>
          <div class="control-group">
            <label>Synonymous Overlay</label>
            <button id="loadActbBtn" style="font-size: 10px">Load ACTB</button>
            <button id="clearOverlayBtn" style="font-size: 10px">Clear Overlay</button>
            <select id="variantSelect" style="margin-top: 4px; font-size: 10px">
              <option value="">-- Select Variant --</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Tools Section -->
      <div class="control-section" data-section="tools">
        <div class="section-header" onclick="toggleSection('tools')">
          <span class="section-toggle">&#9660;</span> Tools
        </div>
        <div class="section-content">
          <div class="control-group">
            <label>Search <span style="font-size: 9px; color: #666;">(Ctrl+F)</span></label>
            <input type="text" id="codonSearch" placeholder="ATG, Met, M..." style="text-transform: uppercase;" />
            <div id="searchResults" style="font-size: 10px; margin-top: 3px; min-height: 14px;"></div>
          </div>
          <div class="control-group">
            <div class="control-row">
              <label><input type="checkbox" id="measureMode" /> Measure Distance</label>
            </div>
            <div class="control-row">
              <label><input type="checkbox" id="showMutationNetwork" /> Mutation Network</label>
            </div>
            <div id="measureResult" style="font-size: 10px; margin-top: 4px; color: #ffcc44; min-height: 14px;"></div>
          </div>
        </div>
      </div>

      <!-- Animation Section - Collapsed by default -->
      <div class="control-section collapsed" data-section="animation">
        <div class="section-header" onclick="toggleSection('animation')">
          <span class="section-toggle">&#9654;</span> Animation
        </div>
        <div class="section-content">
          <div class="control-group">
            <div class="control-row">
              <button id="animateBtn" style="font-size: 10px; flex: 1;">&#9654; Play</button>
              <input type="range" id="animationSpeed" min="100" max="2000" value="500" style="flex: 1;" />
              <span id="speedLabel" style="font-size: 9px; min-width: 40px;">500ms</span>
            </div>
            <div id="animationStatus" style="font-size: 10px; margin-top: 3px; color: #88ccff;"></div>
          </div>
        </div>
      </div>

      <!-- Export Section - Collapsed by default -->
      <div class="control-section collapsed" data-section="export">
        <div class="section-header" onclick="toggleSection('export')">
          <span class="section-toggle">&#9654;</span> Export
        </div>
        <div class="section-content">
          <div class="control-group">
            <div class="control-row">
              <button id="exportPngBtn" style="font-size: 10px;">PNG</button>
              <button id="exportSvgBtn" style="font-size: 10px;">SVG</button>
              <button id="exportCsvBtn" style="font-size: 10px;">CSV</button>
              <button id="exportJsonBtn" style="font-size: 10px;">JSON</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Codon Usage Section - Collapsed by default -->
      <div class="control-section collapsed" data-section="usage">
        <div class="section-header" onclick="toggleSection('usage')">
          <span class="section-toggle">&#9654;</span> Codon Usage
        </div>
        <div class="section-content">
          <div class="control-group">
            <label>Organism bias</label>
            <select id="organismSelect" style="font-size: 11px;">
              <option value="none">None (no bias)</option>
              <option value="ecoli">E. coli K12</option>
              <option value="yeast">S. cerevisiae</option>
              <option value="human">H. sapiens</option>
              <option value="mouse">M. musculus</option>
            </select>
            <div id="usageStats" style="font-size: 10px; margin-top: 4px;"></div>
          </div>
        </div>
      </div>

      <div class="shortcuts-footer">
        <strong>Shortcuts:</strong> F - Search | R - Reset | Space - Play/Pause | 1-3 - Projections<br/>
        <strong>Mouse:</strong> Drag - Rotate | Scroll - Zoom | Right-drag - Pan
      </div>
    </div>

    <div id="info">
      <div class="panel-header" onclick="togglePanel('info')">
        <h3>Hyperbolic Metrics</h3>
        <span class="panel-toggle">&#9660;</span>
      </div>
      <div class="panel-content">
        <div class="stat">Version: <span id="infoVersion">-</span></div>
        <div class="stat">Structure p: <span id="infoStructure">-</span></div>
        <div class="stat">Sequence: <span id="infoSeqLen">-</span></div>
        <div class="stat">Geodesic Dist: <span id="infoGeoDist">-</span></div>
        <h3 style="margin-top: 12px">
          Angular Variance
          <span style="font-size: 9px; color: #666">(Poincare)</span>
        </h3>
        <div class="stat">Intra-AA: <span id="infoIntraVar">-</span></div>
        <div class="stat">Inter-AA: <span id="infoInterVar">-</span></div>
        <div class="stat">Ratio (I/i): <span id="infoVarRatio">-</span></div>
        <button id="loadVarianceBtn" style="margin-top: 6px; font-size: 10px">
          Load Variance
        </button>
      </div>
    </div>

    <div id="tooltip"></div>

    <div id="legend">
      <div class="panel-header" onclick="togglePanel('legend')">
        <h4>Depth Level</h4>
        <span class="panel-toggle">&#9660;</span>
      </div>
      <div class="panel-content" id="legendContent"></div>
    </div>

    <div id="sequence-panel">
      <div class="panel-header">
        <div style="display: flex; align-items: center;">
          <span class="panel-toggle" onclick="togglePanel('sequence-panel')" style="cursor: pointer; margin-right: 6px;">&#9660;</span>
          <h3 onclick="togglePanel('sequence-panel')" style="cursor: pointer;">Encoded Sequence</h3>
        </div>
        <div>
          <button class="expand-btn" onclick="toggleSequenceExpand()" title="Expand/Shrink">&#8597;</button>
        </div>
      </div>
      <div class="panel-content" id="sequence-output">Enter DNA sequence above and click Encode</div>
    </div>

    <script>
      // Section toggle function
      function toggleSection(sectionName) {
        const section = document.querySelector(`[data-section="${sectionName}"]`);
        if (section) {
          section.classList.toggle('collapsed');
          const toggle = section.querySelector('.section-toggle');
          if (section.classList.contains('collapsed')) {
            toggle.innerHTML = '&#9654;'; // Right arrow
          } else {
            toggle.innerHTML = '&#9660;'; // Down arrow
          }
        }
      }

      // Panel toggle function for side panels
      function togglePanel(panelId) {
        const panel = document.getElementById(panelId);
        if (panel) {
          panel.classList.toggle('collapsed');
          const toggle = panel.querySelector('.panel-toggle');
          if (panel.classList.contains('collapsed')) {
            toggle.innerHTML = '&#9654;';
          } else {
            toggle.innerHTML = '&#9660;';
          }
        }
      }

      // Sequence panel expand/shrink
      function toggleSequenceExpand() {
        const panel = document.getElementById('sequence-panel');
        if (panel) {
          panel.classList.toggle('expanded');
          // Also uncollapse if collapsed
          if (panel.classList.contains('collapsed')) {
            panel.classList.remove('collapsed');
            const toggle = panel.querySelector('.panel-toggle');
            toggle.innerHTML = '&#9660;';
          }
        }
      }
    </script>

    <script type="importmap">
      {
        "imports": {
          "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
          "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
        }
      }
    </script>

    <script type="module" src="/static/js/main.js?v=8"></script>
  </body>
</html>
