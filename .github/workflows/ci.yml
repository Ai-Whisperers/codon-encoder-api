name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  PYTHON_VERSION: "3.11"

jobs:
  lint:
    name: Lint & Format
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install linting tools
        run: pip install black isort flake8

      - name: Check formatting with black
        run: black --check --diff visualizer/ server/ tests/

      - name: Check import sorting with isort
        run: isort --check-only --diff visualizer/ server/ tests/

      - name: Lint with flake8
        run: |
          flake8 visualizer/ server/ \
            --max-line-length=120 \
            --ignore=F403,F405,F821,E501,E722,W503

  typecheck:
    name: Type Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          pip install mypy
          pip install torch numpy scikit-learn fastapi pydantic

      - name: Run mypy
        run: mypy visualizer/ server/ --ignore-missing-imports
        continue-on-error: true  # Don't fail build on type errors initially

  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          pip install -e ".[dev]"

      - name: Generate dummy model
        run: python scripts/generate_dummy_model.py

      - name: Run tests with coverage
        run: |
          pytest tests/ \
            -v \
            --cov=visualizer \
            --cov=server \
            --cov-report=xml \
            --cov-report=term-missing

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.xml
          fail_ci_if_error: false

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install security tools
        run: pip install bandit pip-audit

      - name: Run bandit security scan
        run: bandit -r visualizer/ server/ -ll
        continue-on-error: true  # Report but don't fail

      - name: Run pip-audit
        run: |
          pip install torch numpy scikit-learn fastapi pydantic uvicorn
          pip-audit
        continue-on-error: true

  docker:
    name: Docker Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Generate dummy model for Docker build
        run: |
          pip install torch
          python scripts/generate_dummy_model.py

      - name: Build Docker image
        run: docker build -t codon-encoder-api:test .

      - name: Test Docker image
        run: |
          docker run --rm codon-encoder-api:test python -c "from visualizer import server; print('Import OK')"

  all-checks:
    name: All Checks Passed
    runs-on: ubuntu-latest
    needs: [lint, test, docker]
    steps:
      - name: All checks passed
        run: echo "All CI checks passed!"
